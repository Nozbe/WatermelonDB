<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sync - WatermelonDB documentation</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li><a href="../ch01-00-get-excited.html"><strong aria-hidden="true">1.</strong> Get excited</a></li><li><ol class="section"><li><a href="../index.html"><strong aria-hidden="true">1.1.</strong> Check out the README</a></li><li><a href="../Demo.html"><strong aria-hidden="true">1.2.</strong> See the demo</a></li></ol></li><li><a href="../ch02-00-learn-to-use.html"><strong aria-hidden="true">2.</strong> Learn to use Watermelon</a></li><li><ol class="section"><li><a href="../Installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li><a href="../Schema.html"><strong aria-hidden="true">2.2.</strong> Schema</a></li><li><a href="../Model.html"><strong aria-hidden="true">2.3.</strong> Defining Models</a></li><li><a href="../CRUD.html"><strong aria-hidden="true">2.4.</strong> Create, Read, Update, Delete</a></li><li><a href="../Components.html"><strong aria-hidden="true">2.5.</strong> Connecting to React Components</a></li><li><a href="../Query.html"><strong aria-hidden="true">2.6.</strong> Querying</a></li><li><a href="../Relation.html"><strong aria-hidden="true">2.7.</strong> Relations</a></li><li><a href="../Actions.html"><strong aria-hidden="true">2.8.</strong> Custom Actions</a></li></ol></li><li><a href="../ch03-00-advanced.html"><strong aria-hidden="true">3.</strong> Advanced guides</a></li><li><ol class="section"><li><a href="../Advanced/Migrations.html"><strong aria-hidden="true">3.1.</strong> Migrations</a></li><li><a href="../Advanced/Sync.html" class="active"><strong aria-hidden="true">3.2.</strong> Sync</a></li><li><a href="../Advanced/CreateUpdateTracking.html"><strong aria-hidden="true">3.3.</strong> Automatic create/update tracking</a></li><li><a href="../Advanced/AdvancedFields.html"><strong aria-hidden="true">3.4.</strong> Advanced fields</a></li><li><a href="../Advanced/Flow.html"><strong aria-hidden="true">3.5.</strong> Flow</a></li><li><a href="../Advanced/LocalStorage.html"><strong aria-hidden="true">3.6.</strong> LocalStorage</a></li><li><a href="../Advanced/Performance.html"><strong aria-hidden="true">3.7.</strong> Performance tips</a></li></ol></li><li><a href="../ch04-00-deeper.html"><strong aria-hidden="true">4.</strong> Dig deeper into WatermelonDB</a></li><li><ol class="section"><li><a href="../Implementation/Architecture.html"><strong aria-hidden="true">4.1.</strong> Architecture</a></li><li><a href="../Implementation/Adapters.html"><strong aria-hidden="true">4.2.</strong> Adapters</a></li></ol></li><li><a href="../ch04-00-deeper.html"><strong aria-hidden="true">5.</strong> Other</a></li><li><ol class="section"><li><a href="../Roadmap.html"><strong aria-hidden="true">5.1.</strong> Roadmap</a></li><li><a href="../CONTRIBUTING.html"><strong aria-hidden="true">5.2.</strong> Contributing</a></li><li><a href="../CHANGELOG.html"><strong aria-hidden="true">5.3.</strong> Changelog</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">WatermelonDB documentation</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#synchronization" id="synchronization">Synchronization</a></h1>
<p>WatermelonDB has been designed from scratch to be able to seamlessly synchronize with a remote database (and, therefore, keep multiple copies of data synced with each other).</p>
<p>Note that Watermelon is only a local database ‚Äî you need to <strong>bring your own backend</strong>. What Watermelon provides are:</p>
<ul>
<li><strong>Synchronization primitives</strong> ‚Äî information about which records were created, updated, or deleted locally since the last sync ‚Äî and which columns exactly were modified. You can build your own custom sync engine using those primitives</li>
<li><strong>Built-in sync adapter</strong> ‚Äî You can use the sync engine Watermelon provides out of the box, and you only need to provide two API endpoints on your backend that conform to Watermelon sync protocol</li>
</ul>
<h2><a class="header" href="#using-synchronize" id="using-synchronize">Using <code>synchronize()</code></a></h2>
<p>Using Watermelon sync looks roughly like this:</p>
<pre><code class="language-js">import { synchronize } from '@nozbe/watermelondb/sync'

async function mySync() {
  await synchronize({
    database,
    pullChanges: async ({ lastPulledAt }) =&gt; {
      const response = await fetch(`https://my.backend/sync?last_pulled_at=${lastPulledAt}`)
      if (!response.ok) {
        throw new Error(await response.text())
      }

      const { changes, timestamp } = await response.json()
      return { changes, timestamp }
    },
    pushChanges: async ({ changes, lastPulledAt }) =&gt; {
      const response = await fetch(`https://my.backend/sync?last_pulled_at=${lastPulledAt}`, {
        method: 'POST',
        body: JSON.stringify(changes)
      })
      if (!response.ok) {
        throw new Error(await response.text())
      }
    },
  })
}

</code></pre>
<p>You need to pass two functions, <code>pullChanges</code> and <code>pushChanges</code> that can talk to your backend in a compatible way (explained later).</p>
<p><strong>‚ö†Ô∏è Note about a React Native / UglifyES bug</strong>. When you import Watermelon Sync, your app might fail to compile in release mode. To fix this, configure Metro bundler to use Terser instead of UglifyES. Run:</p>
<pre><code class="language-bash">yarn add metro-minify-terser
</code></pre>
<p>Then, update <code>metro.config.js</code>:</p>
<pre><code class="language-js">module.exports = {
  // ...
  transformer: {
    // ...
    minifierPath: 'metro-minify-terser',
  },
}
</code></pre>
<p>You might also need to switch to Terser in Webpack if you use Watermelon for web.</p>
<h3><a class="header" href="#changes-objects" id="changes-objects"><code>changes</code> objects</a></h3>
<p>Changes (received from <code>pullChanges</code> and sent to <code>pushChanges</code>) are represented as an object with <em>raw records</em>. Those only use raw table and column names, and raw values (strings/numbers/booleans) ‚Äî the same as in <a href="../Schema.html">Schema</a>.</p>
<p>Deleted objects are always only represented by their IDs.</p>
<p>Example:</p>
<pre><code class="language-js">{
  projects: {
    created: [
      { id: 'aaaa', name: 'Foo', is_favorite: true },
      { id: 'bbbb', name: 'Bar', is_favorite: false },
    ],
    updated: [
      { id: 'ccc', name: 'Baz', is_favorite: true },
    ],
    deleted: ['ddd'],
  },
  tasks: {
    created: [],
    updated: [
      { id: 'tttt', name: 'Buy eggs' },
    ],
    deleted: [],
  },
  ...
}
</code></pre>
<h3><a class="header" href="#pullchanges" id="pullchanges"><code>pullChanges()</code></a></h3>
<p>Arguments: <code>{ lastPulledAt }</code>:</p>
<ul>
<li><code>lastPulledAt</code> is a timestamp for the last time client pulled changes from server (or <code>null</code> if first sync)</li>
</ul>
<p>This function should fetch from the server the list of ALL changes in all collections since <code>lastPulledAt</code>:</p>
<ul>
<li>records that were created on the server</li>
<li>records that were updated on the server</li>
<li>IDs of records that were deleted on the server</li>
</ul>
<p>Return a Promise resolving to an object like this:</p>
<pre><code>{
  changes: { ... },
  timestamp: 100000, // Return *server's* current time
}
</code></pre>
<p>Raw records passed must match your app <a href="../Schema.html">Schema</a>, and must not contain special <code>_status</code>, <code>_changed</code> fields.</p>
<p>The timestamp returned by the server must be a value that, if passed again to <code>pullChanges()</code> as <code>lastPulledAt</code>, will return all changes that happened since this moment.</p>
<h3><a class="header" href="#pushchanges" id="pushchanges"><code>pushChanges()</code></a></h3>
<p>This function will be called to push local (app) changes to the server</p>
<p>Arguments:</p>
<pre><code>{
  changes: { ... },
  // the timestamp of the last successful pull (timestamp returned in pullChanges)
  lastSyncedAt: 10000,
}
</code></pre>
<p><strong>Note:</strong> Records sent to pushChanges might contain special <code>_status</code>, <code>_changed</code> fields. You must ignore them. You must not mutate passed changes object.</p>
<p><code>pushChanges</code> should call the server with the changes, and apply them remotely (create/update/delete on the server records that were created/updated/deleted locally).</p>
<p>If successful, <code>pushChanges</code> should resolve. If there's a problem, server should revert all changes, and <code>pushChanges</code> should reject.</p>
<p>If a record that's being pushed to the server has been changed on the server AFTER the time specified by <code>lastSyncedAt</code> (which means someone modified what we're pushing between pullChanges and pushChanges), we have a conflict, and push should be aborted. (<code>pushChanges</code> should reject). The local changes will sync during next sync.</p>
<h3><a class="header" href="#implementation-tips" id="implementation-tips">Implementation tips</a></h3>
<p>Synchronization is serious business! It's very easy to make mistakes that will cause data loss. If you're not experienced at this, stick to these rules and suggestions:</p>
<ul>
<li><strong>Using <code>synchronize()</code></strong>
<ul>
<li>Ensure you never call <code>synchronize()</code> while synchronization is already in progress</li>
<li>We recommend wrapping <code>synchronize()</code> in a &quot;retry once&quot; block - if sync fails, try again once.</li>
<li>You can use <code>database.withChangesForTables</code> to detect when local changes occured to call sync</li>
</ul>
</li>
<li><strong>Implementing server-side changes tracking</strong>
<ul>
<li>Add a <code>last_modified</code> field to all your server database tables, and bump it to <code>NOW()</code> every time you create or update a record.</li>
<li>This way, when you want to get all changes since <code>lastPulledAt</code>, you query records whose <code>last_modified &gt; lastPulledAt</code>.</li>
<li>For extra safety, we recommend adding a MySQL/PostgreSQL procedure that will ensure <code>last_modified</code> uniqueness and monotonicity (will increment it by one if a record with this <code>last_modified</code> or greater already exists in the database).
<blockquote>
<p>This protects against weird edge cases related to server clock time changes (NTP time sync, leap seconds, etc.)
(Alternatively, instead of using timestamps, you could use auto-incrementing couters, but you'd have to ensure they are consistent across the whole database, not just one table)</p>
</blockquote>
</li>
<li>You do need to implement a mechanism to track when records were deleted on the server, otherwise you wouldn't know to push them</li>
<li>To distinguish between <code>created</code> and <code>updated</code> records, you can also store server-side <code>server_created_at</code> timestamp (if it's greater than <code>last_pulled_at</code> supplied to sync, then record is to be <code>created</code> on client, if less than ‚Äî client already has it and it is to be <code>updated</code> on client). Note that this timestamp must be consistent with last_modified ‚Äî and you must not use client-created <code>created_at</code> field, since you can never trust local timestamps.
<ul>
<li>Alternatively, you can send all non-deleted records as all <code>updated</code> and Watermelon will do the right thing in 99% of cases (you will be slightly less protected against weird edge cases ‚Äî treatment of locally deleted records is different). If you do this, pass <code>sendCreatedAsUpdated: true</code> to <code>synchronize()</code> to supress warnings about records to be updated not existing locally.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Implementing <code>GET changes</code> API endpoint</strong>
<ul>
<li>Make sure you perform all queries (and checking for current timestamp) synchronously
<blockquote>
<p>This is to ensure that no changes are made to the database while you're fetching changes (otherwise you could never sync some records)</p>
</blockquote>
<ul>
<li>if it's not possible to do so (you have to query each collection separately), be sure to mark <code>NOW()</code> to respond with at the <em>beginning</em> of the process. You still risk inconsistent responses, but the next pull will fetch whatever changes occured during previous pull.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Implementing <code>POST changes</code> API endpoint</strong>
<ul>
<li>Make sure you perform all changes on all tables in a transaction! If push fails, you don't want partially applied changes.</li>
<li>Compare db record's <code>last_modified</code> time with <code>lastPulledAt</code>. If it's greater, we have a conflict, and you must abort transaction and return error status.</li>
<li>If client wants to:
<ul>
<li>‚Ä¶ delete a record that don't exist ‚Äî just ignore it</li>
<li>‚Ä¶ update a record that doesn't exist, create it</li>
<li>‚Ä¶ create a record that does exist, update it</li>
</ul>
</li>
<li>If there's something wrong with the data format, prefer to &quot;fix&quot; the data if possible instead of failing sync. You don't want the user to have an unsyncable app because of a mistake caused by a bug 5 versions ago.</li>
<li>As with any API, remember to check permissions to create/modify records, make sure you version your API together with local Schema versioning, and all other standard stuff!</li>
</ul>
</li>
<li><strong>Adding logging to your sync</strong>
<ul>
<li>
<p>You can add basic sync logs to the sync process by passing an empty object to <code>synchronize()</code>. Sync will then mutate the object, populating it with diagnostic information (start/finish time, resolved conflicts, and more):</p>
<pre><code class="language-js">const log = {}
await synchronize({
  database,
  log,
  ...
})
console.log(log.startedAt)
console.log(log.finishedAt)
</code></pre>
</li>
<li>
<p>‚ö†Ô∏è Remember to act responsibly with logs, since they might contain your user's private information. Don't display, save, or send the log unless you censor the log. <a href="https://gist.github.com/radex/a0a27761ac348f4a5552ecaf227d500c">Example logger and censor code you can use</a>.</p>
</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#current-limitations" id="current-limitations">Current limitations</a></h3>
<ol>
<li>If a record being pushed changes between pull and push, push will just fail. It would be better if it failed with a list of conflicts, so that <code>synchronize()</code> can automatically respond. Alternatively, sync could only send changed fields and server could automatically always just apply those changed fields to the server version (since that's what per-column client-wins resolver will do anyway)</li>
<li>During next sync pull, changes we've just pushed will be pulled again, which is unnecessary. It would be better if server, during push, also pulled local changes since <code>lastPulledAt</code> and responded with NEW timestamp to be treated as <code>lastPulledAt</code>.</li>
<li>It shouldn't be necessary to push the whole updated record ‚Äî just changed fields + ID should be enough</li>
</ol>
<blockquote>
<p>Note: That might conflict with &quot;If client wants to update a record that doesn‚Äôt exist, create it&quot;</p>
</blockquote>
<ol start="4">
<li>The performance of <code>synchronize()</code> has not yet been optimized</li>
</ol>
<h3><a class="header" href="#contributing" id="contributing">Contributing</a></h3>
<ol>
<li>If you implement Watermelon sync but found this guide confusing, please contribute improvements!</li>
<li>Please help out with solving the current limitations!</li>
<li>If you write server-side code made to be compatible with Watermelon, especially for popular platforms (Node, Ruby on Rails, Kinto, etc.) - please open source it and let us know! This would dramatically simplify implementing sync for people</li>
<li>If you find Watermelon sync bugs, please report the issue! And if possible, write regression tests to make sure it never happens again</li>
</ol>
<h2><a class="header" href="#sync-primitives-and-implementing-your-own-sync" id="sync-primitives-and-implementing-your-own-sync">Sync primitives and implementing your own sync</a></h2>
<p>For basic details about how changes tracking works, see: <a href="https://www.youtube.com/watch?v=uFvHURTRLxQ">üì∫ Digging deeper into WatermelonDB</a></p>
<p>Why you might want to implement a custom sync engine? If you have an existing remote server architecture that's difficult to adapt to Watermelon sync protocol, or you specifically want a different architecture (e.g. single HTTP request -- server resolves conflicts). Be warned, however, that implementing sync that works correctly is very hard.</p>
<p>For details about how Watermelon sync works, see design documentation in <code>sync/index.js</code>. You can use that as a blueprint for your own implementation.</p>
<p>If possible, please use sync implementation helpers from <code>sync/*.js</code> to keep your custom sync implementation have as much commonality as possible with the standard implementation. If the helpers are <em>almost</em> what you need, but not quite, please send pull requests with improvements!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../Advanced/Migrations.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../Advanced/CreateUpdateTracking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../Advanced/Migrations.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../Advanced/CreateUpdateTracking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
