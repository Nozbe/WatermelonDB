---
title: åŒæ­¥å®ç°
hide_title: true
---

# åŒæ­¥å®ç°ç»†èŠ‚

å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾åœ¨åº”ç”¨ç¨‹åºä¸­å®ç° Watermelon Sync çš„æŒ‡å—ï¼Œè¯·å‚é˜… [**åŒæ­¥**](../Sync/Intro.md)ã€‚

å¦‚æœæ‚¨æƒ³ä¸º Watermelon Sync åšå‡ºè´¡çŒ®ï¼Œæˆ–è€…ä»å¤´å¼€å§‹å®ç°è‡ªå·±çš„åŒæ­¥å¼•æ“ï¼Œè¯·é˜…è¯»æœ¬æ–‡ã€‚

## ä»å¤´å¼€å§‹å®ç°è‡ªå·±çš„åŒæ­¥åŠŸèƒ½

æœ‰å…³æ›´æ”¹è·Ÿè¸ªå·¥ä½œåŸç†çš„åŸºæœ¬ç»†èŠ‚ï¼Œè¯·å‚é˜…ï¼š[ğŸ“º æ·±å…¥äº†è§£ WatermelonDB](https://www.youtube.com/watch?v=uFvHURTRLxQ)

ä¸ºä»€ä¹ˆæ‚¨å¯èƒ½æƒ³å®ç°ä¸€ä¸ªè‡ªå®šä¹‰åŒæ­¥å¼•æ“å‘¢ï¼Ÿå¦‚æœæ‚¨ç°æœ‰çš„è¿œç¨‹æœåŠ¡å™¨æ¶æ„éš¾ä»¥é€‚åº” Watermelon åŒæ­¥åè®®ï¼Œæˆ–è€…æ‚¨ç‰¹åˆ«æƒ³è¦ä¸€ç§ä¸åŒçš„æ¶æ„ï¼ˆä¾‹å¦‚ï¼Œå•ä¸ª HTTP è¯·æ±‚â€”â€”ç”±æœåŠ¡å™¨è§£å†³å†²çªï¼‰ã€‚ä¸è¿‡è¯·æ³¨æ„ï¼Œ**å®ç°ä¸€ä¸ªå¯é çš„åŒæ­¥åŠŸèƒ½**æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œå› æ­¤æˆ‘ä»¬å»ºè®®æ‚¨åšæŒä½¿ç”¨ Watermelon Sync å¹¶æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚

æœ¬æ–‡æ¡£çš„å…¶ä½™éƒ¨åˆ†åŒ…å«äº† Watermelon Sync å·¥ä½œåŸç†çš„è¯¦ç»†ä¿¡æ¯â€”â€”æ‚¨å¯ä»¥å°†å…¶ä½œä¸ºè‡ªå·±å·¥ä½œçš„è“å›¾ã€‚

å¦‚æœå¯èƒ½çš„è¯ï¼Œè¯·ä½¿ç”¨ `sync/*.js` ä¸­çš„åŒæ­¥å®ç°è¾…åŠ©å‡½æ•°ï¼Œä»¥ä½¿æ‚¨çš„è‡ªå®šä¹‰åŒæ­¥å®ç°å°½å¯èƒ½ä¸æ ‡å‡†å®ç°ä¿æŒä¸€è‡´ã€‚è¿™å¯¹æ‚¨å’Œ WatermelonDB ç¤¾åŒºçš„å…¶ä»–æˆå‘˜éƒ½æœ‰å¥½å¤„ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å…±äº«æ”¹è¿›å’Œ bug ä¿®å¤ã€‚å¦‚æœè¿™äº›è¾…åŠ©å‡½æ•°**å‡ ä¹**èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œä½†è¿˜ä¸å®Œå…¨ç¬¦åˆï¼Œè¯·æäº¤åŒ…å«æ”¹è¿›å†…å®¹çš„æ‹‰å–è¯·æ±‚ï¼

## Watermelon Sync â€”â€” è¯¦ç»†ä¿¡æ¯

### æ€»ä½“è®¾è®¡

- ä¸»/å‰¯æœ¬æ¨¡å¼ - æœåŠ¡å™¨æ˜¯äº‹å®æ¥æºï¼Œå®¢æˆ·ç«¯æ‹¥æœ‰å®Œæ•´å‰¯æœ¬å¹¶å°†æ›´æ”¹åŒæ­¥å›æœåŠ¡å™¨ï¼ˆä¸æ”¯æŒç‚¹å¯¹ç‚¹åŒæ­¥ï¼‰
- ä¸¤é˜¶æ®µåŒæ­¥ï¼šé¦–å…ˆå°†è¿œç¨‹æ›´æ”¹æ‹‰å–åˆ°æœ¬åœ°åº”ç”¨ï¼Œç„¶åå°†æœ¬åœ°æ›´æ”¹æ¨é€åˆ°æœåŠ¡å™¨
- ç”±å®¢æˆ·ç«¯è§£å†³å†²çª
- åŸºäºå†…å®¹è€ŒéåŸºäºæ—¶é—´çš„å†²çªè§£å†³æœºåˆ¶
- ä½¿ç”¨æŒ‰åˆ—çš„å®¢æˆ·ç«¯ä¼˜å…ˆç­–ç•¥è§£å†³å†²çªï¼šå‘ç”Ÿå†²çªæ—¶ï¼Œé‡‡ç”¨æœåŠ¡å™¨ç‰ˆæœ¬ï¼Œä½†è‡ªä¸Šæ¬¡åŒæ­¥ä»¥æ¥æœ¬åœ°æœ‰æ›´æ”¹çš„åˆ—é™¤å¤–ã€‚
- æœ¬åœ°åº”ç”¨ä½¿ç”¨ _statusï¼ˆå·²åŒæ­¥/å·²åˆ›å»º/å·²æ›´æ–°/å·²åˆ é™¤ï¼‰å­—æ®µå’Œ _changes å­—æ®µï¼ˆæŒ‡å®šè‡ªä¸Šæ¬¡åŒæ­¥ä»¥æ¥æ›´æ”¹çš„åˆ—ï¼‰è·Ÿè¸ªå…¶æ›´æ”¹
- æœåŠ¡å™¨ä»…è·Ÿè¸ªæ¯æ¡è®°å½•çš„æ—¶é—´æˆ³ï¼ˆæˆ–ç‰ˆæœ¬å·ï¼‰ï¼Œä¸è·Ÿè¸ªå…·ä½“æ›´æ”¹
- åŒæ­¥æ“ä½œä¸€æ¬¡æ€§å¯¹æ•´ä¸ªæ•°æ®åº“æ‰§è¡Œï¼Œè€ŒéæŒ‰é›†åˆè¿›è¡Œ
- æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¦‚æœæ²¡æœ‰æœ¬åœ°æ›´æ”¹éœ€è¦æ¨é€ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨æˆåŠŸæ‹‰å–æ•°æ®æ—¶ä¿æŒä¸€è‡´ï¼‰
- éé˜»å¡ï¼šæœ¬åœ°æ•°æ®åº“å†™å…¥æ“ä½œï¼ˆä½†ä¸åŒ…æ‹¬è¯»å–æ“ä½œï¼‰ä»…åœ¨å†™å…¥æ•°æ®æ—¶çŸ­æš‚é”å®šï¼Œç”¨æˆ·å¯ä»¥åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å®‰å…¨åœ°è¿›è¡Œæ–°çš„æ›´æ”¹

### åŒæ­¥æµç¨‹

1. æ‹‰å–é˜¶æ®µ
  - ä»æœ¬åœ°è·å– `lastPulledAt` æ—¶é—´æˆ³ï¼ˆé¦–æ¬¡åŒæ­¥æ—¶ä¸º nullï¼‰
  - è°ƒç”¨ `pullChanges` å‡½æ•°ï¼Œå¹¶ä¼ å…¥ `lastPulledAt`
    - æœåŠ¡å™¨è¿”å›è‡ª `lastPulledAt` ä»¥æ¥å‘ç”Ÿçš„æ‰€æœ‰æ›´æ”¹ï¼ˆåˆ›å»º/æ›´æ–°/åˆ é™¤ï¼‰
    - æœåŠ¡å™¨æä¾›å…¶å½“å‰æ—¶é—´æˆ³
  - æ‰§è¡Œæ“ä½œï¼ˆé”å®šæœ¬åœ°å†™å…¥ï¼‰ï¼š
    - ç¡®ä¿æ²¡æœ‰å¹¶å‘åŒæ­¥æ“ä½œ
    - åœ¨æœ¬åœ°åº”ç”¨è¿œç¨‹æ›´æ”¹
      - æ’å…¥æ–°è®°å½•
        - å¦‚æœè®°å½•å·²å­˜åœ¨ï¼ˆæŠ¥é”™ï¼‰ï¼Œåˆ™æ›´æ–°è®°å½•
        - å¦‚æœè®°å½•åœ¨æœ¬åœ°å·²æ ‡è®°ä¸ºåˆ é™¤ï¼ˆæŠ¥é”™ï¼‰ï¼Œåˆ™å–æ¶ˆåˆ é™¤å¹¶æ›´æ–°è®°å½•
      - æ›´æ–°è®°å½•
        - å¦‚æœè®°å½•å·²åŒæ­¥ï¼Œç›´æ¥ç”¨æœåŠ¡å™¨ç‰ˆæœ¬æ›¿æ¢å†…å®¹
        - å¦‚æœè®°å½•åœ¨æœ¬åœ°å·²æ›´æ–°ï¼Œåˆ™å‘ç”Ÿå†²çªï¼
          - é‡‡ç”¨è¿œç¨‹ç‰ˆæœ¬ï¼Œåº”ç”¨è‡ªä¸Šæ¬¡åŒæ­¥ä»¥æ¥åœ¨æœ¬åœ°æ›´æ”¹è¿‡çš„å­—æ®µ
            ï¼ˆæŒ‰åˆ—çš„å®¢æˆ·ç«¯ä¼˜å…ˆç­–ç•¥ï¼‰
          - è®°å½•ä»æ ‡è®°ä¸ºå·²æ›´æ–°ï¼Œå› ä¸ºæœ¬åœ°æ›´æ”¹ä»éœ€æ¨é€
        - å¦‚æœè®°å½•åœ¨æœ¬åœ°å·²æ ‡è®°ä¸ºåˆ é™¤ï¼Œåˆ™å¿½ç•¥ï¼ˆåˆ é™¤æ“ä½œç¨åæ¨é€ï¼‰
        - å¦‚æœè®°å½•åœ¨æœ¬åœ°ä¸å­˜åœ¨ï¼ˆæŠ¥é”™ï¼‰ï¼Œåˆ™åˆ›å»ºè®°å½•
      - åˆ é™¤è®°å½•
        - å¦‚æœè®°å½•å·²åˆ é™¤ï¼Œåˆ™å¿½ç•¥
        - å¦‚æœè®°å½•åœ¨æœ¬åœ°å·²æ›´æ”¹ï¼Œä»æ‰§è¡Œåˆ é™¤æ“ä½œ
        - å¿½ç•¥å­è®°å½•ï¼ˆæœåŠ¡å™¨åº”å®‰æ’åˆ é™¤å­è®°å½•ï¼‰
    - å¦‚æœæ“ä½œæˆåŠŸï¼Œå°†æœåŠ¡å™¨çš„æ—¶é—´æˆ³ä¿å­˜ä¸ºæ–°çš„ `lastPulledAt`
2. æ¨é€é˜¶æ®µ
  - è·å–æœ¬åœ°æ›´æ”¹
    - æŸ¥æ‰¾æ‰€æœ‰é›†åˆä¸­æ‰€æœ‰åœ¨æœ¬åœ°æ›´æ”¹è¿‡çš„è®°å½•ï¼ˆå·²åˆ›å»º/æ›´æ–°çš„è®°å½• + å·²åˆ é™¤çš„è®°å½• IDï¼‰
    - å»é™¤ _status å’Œ _changed å­—æ®µ
  - è°ƒç”¨ `pushChanges` å‡½æ•°ï¼Œä¼ å…¥æœ¬åœ°æ›´æ”¹å¯¹è±¡å’Œæ–°çš„ `lastPulledAt` æ—¶é—´æˆ³
    - æœåŠ¡å™¨å°†æœ¬åœ°æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼Œå¹¶è¿”å› OK
    - å¦‚æœæ¨é€çš„è®°å½•ä¸­æœ‰ä¸€æ¡è‡ª `lastPulledAt` ä»¥æ¥åœ¨*æœåŠ¡å™¨ç«¯*å‘ç”Ÿäº†æ›´æ”¹ï¼Œåˆ™æ¨é€æ“ä½œä¸­æ­¢ï¼Œ
      æ‰€æœ‰æ›´æ”¹è¢«å›æ»šï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯ä¿¡æ¯
  - æ‰§è¡Œæ“ä½œï¼ˆé”å®šæœ¬åœ°å†™å…¥ï¼‰ï¼š
    - å°†æœ¬åœ°æ›´æ”¹æ ‡è®°ä¸ºå·²åŒæ­¥ï¼š
      - å–ä¸Šä¸€æ­¥è·å–çš„æœ¬åœ°æ›´æ”¹ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
      - æ°¸ä¹…åˆ é™¤æ ‡è®°ä¸ºå·²åˆ é™¤çš„è®°å½•
      - å°†å·²åˆ›å»º/æ›´æ–°çš„è®°å½•æ ‡è®°ä¸ºå·²åŒæ­¥ï¼Œå¹¶é‡ç½®å…¶ _changed å­—æ®µ
      - æ³¨æ„ï¼šå¦‚æœè®°å½•è‡ª â€œè·å–æœ¬åœ°æ›´æ”¹â€ æ­¥éª¤ä»¥æ¥åœ¨æœ¬åœ°å‘ç”Ÿäº†æ›´æ”¹ï¼Œ*ä¸è¦*å°†å…¶æ ‡è®°ä¸ºå·²åŒæ­¥
        ï¼ˆç”¨æˆ·å¯èƒ½æœ‰éœ€è¦åŒæ­¥çš„æ–°æ›´æ”¹ï¼‰

### æ³¨æ„äº‹é¡¹

- æ­¤æµç¨‹çš„è®¾è®¡ä¿è¯äº†ï¼Œå³ä½¿åŒæ­¥åœ¨ä»»ä½•æ—¶åˆ»å¤±è´¥ï¼Œç”šè‡³ä½¿æœ¬åœ°åº”ç”¨å¤„äºä¸ä¸€è‡´ï¼ˆæœªå®Œå…¨åŒæ­¥ï¼‰çš„çŠ¶æ€ï¼Œæˆ‘ä»¬ä»èƒ½åœ¨ä¸‹æ¬¡åŒæ­¥æ—¶å®ç°ä¸€è‡´æ€§ï¼š
  - `applyRemoteChanges` å‡½æ•°çš„è®¾è®¡ä½¿å¾—ï¼Œå¦‚æœæ‰€æœ‰æ›´æ”¹éƒ½å·²åº”ç”¨ï¼Œä½† `lastPulledAt` æœªä¿å­˜æˆåŠŸ â€”â€” é‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡æ‹‰å–æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå†æ¬¡æä¾›ç›¸åŒçš„æ›´æ”¹ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œ `applyRemoteChanges` ä¼šå¾—åˆ°ç›¸åŒçš„ç»“æœã€‚
  - â€œè·å–æœ¬åœ°æ›´æ”¹â€ æ­¥éª¤ä¹‹å‰çš„æœ¬åœ°æ›´æ”¹æ— å…³ç´§è¦ â€”â€” ç”¨æˆ·å¯ä»¥éšæ„æ“ä½œã€‚
  - â€œè·å–æœ¬åœ°æ›´æ”¹â€ å’Œ â€œå°†æœ¬åœ°æ›´æ”¹æ ‡è®°ä¸ºå·²åŒæ­¥â€ è¿™ä¸¤ä¸ªæ­¥éª¤ä¹‹é—´çš„æœ¬åœ°æ›´æ”¹å°†è¢«å¿½ç•¥ï¼ˆä¸ä¼šè¢«æ ‡è®°ä¸ºå·²åŒæ­¥ï¼‰ â€”â€” è¿™äº›æ›´æ”¹å°†åœ¨ä¸‹æ¬¡åŒæ­¥æ—¶æ¨é€ã€‚
  - å¦‚æœæ›´æ”¹æœªè¢«æ ‡è®°ä¸ºå·²åŒæ­¥å¹¶å†æ¬¡è¢«æ¨é€ï¼ŒæœåŠ¡å™¨åº”é‡‡ç”¨ç›¸åŒçš„æ–¹å¼åº”ç”¨è¿™äº›æ›´æ”¹ã€‚
  - æ‹‰å–é˜¶æ®µå’Œæ¨é€é˜¶æ®µä¹‹é—´çš„è¿œç¨‹æ›´æ”¹å°†åœ¨æœ¬åœ°è¢«å¿½ç•¥ï¼ˆä¼šåœ¨ä¸‹æ¬¡åŒæ­¥æ—¶æ‹‰å–ï¼‰ï¼Œé™¤éå­˜åœ¨å•æ¡è®°å½•çš„å†²çªï¼ˆæ­¤æ—¶æ¨é€å¤±è´¥ï¼Œä½†ä¸‹æ¬¡åŒæ­¥ä¼šåŒæ—¶è§£å†³æ‹‰å–å’Œæ¨é€é—®é¢˜ï¼‰ã€‚

### è¿ç§»åŒæ­¥

æ¨¡å¼ç‰ˆæœ¬æ§åˆ¶å’Œè¿ç§»æ“ä½œä½¿åŒæ­¥å˜å¾—å¤æ‚ï¼Œå› ä¸ºå®¢æˆ·ç«¯å¯èƒ½æ— æ³•åŒæ­¥æŸäº›è¡¨å’Œåˆ—ï¼Œä½†åœ¨å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬åï¼Œåº”è¯¥èƒ½å¤Ÿå®ç°ä¸€è‡´çš„åŒæ­¥ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸Šæ¬¡åŒæ­¥æ—¶çš„æ¨¡å¼ç‰ˆæœ¬ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒWatermelon Sync ä»ç¬¬ä¸€ä¸ªç‰ˆæœ¬å¼€å§‹å°±æ²¡æœ‰è·Ÿè¸ªè¿™ä¸€ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦è¿›è¡Œå‘åå…¼å®¹å¤„ç†ã€‚

```
synchronize({ migrationsEnabledAtVersion: XXX })

. . . .

LPA = Last Pulled At, ä¸Šæ¬¡æ‹‰å–æ—¶é—´
MEA = Migrations Enabled At version, å¯ç”¨è¿ç§»æ”¯æŒçš„æ¨¡å¼ç‰ˆæœ¬ï¼Œå³å¼•å…¥æœªæ¥è¿ç§»æ”¯æŒçš„æ¨¡å¼ç‰ˆæœ¬
LS = Last Synced schema version, ä¸Šæ¬¡åŒæ­¥çš„æ¨¡å¼ç‰ˆæœ¬ï¼ˆç”±äºå‘åå…¼å®¹é—®é¢˜ï¼Œå¯èƒ½ä¸º nullï¼‰
CV = Current schema Version, å½“å‰æ¨¡å¼ç‰ˆæœ¬

LPA     MEA     LS      CV      è¿ç§»æƒ…å†µ   è®¾ç½® LS=CV?   å¤‡æ³¨

null    X       X       10      æ—         æ˜¯          é¦–æ¬¡åŒæ­¥ã€‚æ— è®ºåº”ç”¨æ˜¯å¦æ”¯æŒè¿ç§»åŒæ­¥ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è®°å½• LS=CVï¼Œä»¥ä¾¿åœ¨æœ‰å¯ç”¨è¿ç§»æ—¶è·å–æ‰€æœ‰è¿ç§»ã€‚

100     null    X       X       æ—         å¦          è¡¨ç¤ºåº”ç”¨ä¸æ”¯æŒè¿ç§»åŒæ­¥ï¼Œå› æ­¤ä¸è®¾ç½® LSï¼Œä»¥ä¾¿æœªæ¥æ”¯æŒè¿ç§»åŒæ­¥ã€‚

100     X       10      10      æ—         å¦          ç‰ˆæœ¬æœ€æ–°ï¼Œæ— éœ€è¿ç§»ã€‚

100     9       9       10      {9-10}    æ˜¯          æ­£ç¡®çš„è¿ç§»åŒæ­¥ã€‚

100     9       null    10      {9-10}    æ˜¯          å›é€€è¿ç§»ã€‚å¯èƒ½ä¸åŒ…å«æ‰€æœ‰å¿…è¦çš„è¿ç§»ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ç¡®å®šç”¨æˆ·åœ¨å½“æ—¶çš„ç‰ˆæœ¬ï¼ˆå³ MEAï¼‰ç™»å½•ã€‚

100     9       11      10      é”™è¯¯      å¦          LS > CV è¡¨ç¤ºç¼–ç¨‹é”™è¯¯ã€‚

100     11      X       10      é”™è¯¯      å¦          MEA > CV è¡¨ç¤ºç¼–ç¨‹é”™è¯¯ã€‚
```

### å‚è€ƒèµ„æ–™

æ­¤è®¾è®¡å‚è€ƒäº†ä»¥ä¸‹å†…å®¹ï¼š

- Nozbe å…¬å¸åœ¨æ„å»ºåŒæ­¥åŠŸèƒ½æ–¹é¢çš„ 10 å¹´ç»éªŒ
- Kinto ä¸ Kinto.js
  - https://github.com/Kinto/kinto.js/blob/master/src/collection.js
  - https://kintojs.readthedocs.io/en/latest/api/#fetching-and-publishing-changes
- Histo - https://github.com/mirkokiefer/syncing-thesis
